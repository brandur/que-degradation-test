#!/usr/bin/env ruby

require_relative "../common"

# + 1 extra for the main thread
DB = Sequel.connect(DATABASE_URL, max_connections: WORKER_COUNT + 1)
Que.connection = DB
Que.logger = Logger.new($stdout)
Que.mode = :async
Que.worker_count = WORKER_COUNT

jobs_worked = 0
Que.log_formatter = lambda do |data|
  case data[:event].to_sym
  when :job_worked
    jobs_worked += 1
    if jobs_worked % BATCH_SIZE == 0
      puts "worked #{BATCH_SIZE} jobs (queue count = #{DB[:que_jobs].count})"
    end
  end

  nil
end

# Exit immediately, killing any in-flight jobs
trap('INT') do
  puts "received SIGINT"
  exit
end

stop = false
# Exit gracefully, finishing any in-flight jobs.
trap('TERM') do
  puts "received SIGTERM"
  stop = true
end

loop do
  puts "queue count = #{DB[:que_jobs].count}"
  sleep 0.5
  break if stop
end
